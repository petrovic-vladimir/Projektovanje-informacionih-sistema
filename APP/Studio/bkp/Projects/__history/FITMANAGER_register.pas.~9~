unit FITMANAGER_register;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.Objects,
  FMX.Controls.Presentation, FMX.StdCtrls, FMX.Edit, FMX.DialogService,
  DB;

type
  TFrmRegister = class(TForm)
    register_template: TImage;
    Button1: TButton;        // BACK button (arrow)
    Username_input: TEdit;
    Name_input: TEdit;
    Lname_input: TEdit;
    JMBG_input: TEdit;
    Email_input: TEdit;
    Password_input: TEdit;
    RepeatPass_input: TEdit;
    Edit1: TEdit;            // phone
    Button2: TButton;        // CREATE (invisible button over template)
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
  private
    procedure GoToLogin;
  public
  end;

var
  FrmRegister: TFrmRegister;

implementation

{$R *.fmx}

procedure TFrmRegister.GoToLogin;
begin
  if Application.MainForm <> nil then
    Application.MainForm.Show;

  Self.Hide;
end;

procedure TFrmRegister.Button1Click(Sender: TObject);
begin
  // BACK arrow
  GoToLogin;
end;

procedure TFrmRegister.Button2Click(Sender: TObject);
var
  NameV, LnameV, UsernameV, EmailV, PassV, Pass2V, JMBGV, PhoneV: string;
begin
  NameV     := Trim(Name_input.Text);
  LnameV    := Trim(Lname_input.Text);
  UsernameV := Trim(Username_input.Text);
  EmailV    := Trim(Email_input.Text);
  PassV     := Password_input.Text;
  Pass2V    := RepeatPass_input.Text;
  JMBGV     := Trim(JMBG_input.Text);
  PhoneV    := Trim(Edit1.Text);

  if (NameV='') or (LnameV='') or (UsernameV='') or (EmailV='') or (PassV='') or
     (Pass2V='') or (JMBGV='') or (PhoneV='') then
  begin
    ShowMessage('Popuni sva polja.');
    Exit;
  end;

  if PassV <> Pass2V then
  begin
    ShowMessage('Lozinke se ne poklapaju.');
    Exit;
  end;

  if dmDB = nil then
  begin
    ShowMessage('Database module not loaded.');
    Exit;
  end;

  if dmDB.RegisterUser(NameV, LnameV, UsernameV, PassV, EmailV, JMBGV, PhoneV) then
  begin
    ShowMessage('Registracija uspesna.');
    GoToLogin;
  end
  else
    ShowMessage('Registracija neuspesna. Proveri podatke.');
end;

procedure TFrmRegister.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := TCloseAction.caFree;
  FrmRegister := nil;
end;

procedure TFrmRegister.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  CanClose := False;

  TDialogService.MessageDialog(
    'Da li ste sigurni da zelite da napustite aplikaciju?',
    TMsgDlgType.mtConfirmation,
    [TMsgDlgBtn.mbYes, TMsgDlgBtn.mbNo],
    TMsgDlgBtn.mbNo,
    0,
    procedure(const AResult: TModalResult)
    begin
      if AResult = mrYes then
        Application.Terminate;
    end
  );
end;

end.

