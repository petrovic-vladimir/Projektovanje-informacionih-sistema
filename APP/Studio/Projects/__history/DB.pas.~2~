unit DB;

interface

uses
  System.SysUtils, System.Classes,
  Data.DB,
  FireDAC.Comp.Client, FireDAC.Comp.DataSet,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Stan.Param,
  FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt,
  FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Phys,
  FireDAC.FMXUI.Wait, FireDAC.Phys.ODBC, FireDAC.Phys.ODBCDef;

type
  TdmDB = class(TDataModule)
    DbConnect: TFDConnection;
    Query_getAllUsers: TFDQuery;
  private
    FCurrentUserId: Integer;
    FCurrentUsername: string;
    FCurrentEmail: string;
    procedure ResetCurrentUser;
    procedure EnsureConnected;
  public
    function AuthenticateUser(const ALogin, APassword: string): Boolean;

    property CurrentUserId: Integer read FCurrentUserId;
    property CurrentUsername: string read FCurrentUsername;
    property CurrentEmail: string read FCurrentEmail;
  end;

var
  dmDB: TdmDB;

implementation

{%CLASSGROUP 'FMX.Controls.TControl'}

{$R *.dfm}

procedure TdmDB.EnsureConnected;
begin
  if not DbConnect.Connected then
    DbConnect.Connected := True;
end;

procedure TdmDB.ResetCurrentUser;
begin
  FCurrentUserId := 0;
  FCurrentUsername := '';
  FCurrentEmail := '';
end;

function TdmDB.AuthenticateUser(const ALogin, APassword: string): Boolean;
var
  Q: TFDQuery;
  LLogin: string;
begin
  ResetCurrentUser;
  EnsureConnected;

  LLogin := Trim(ALogin);

  Q := TFDQuery.Create(nil);
  try
    Q.Connection := DbConnect;
    Q.SQL.Text :=
      'SELECT TOP 1 Id, Username, Email ' +
      'FROM [User] ' +
      'WHERE (Username = :login OR Email = :login) ' +
      '  AND [Password] = :pass';

    Q.ParamByName('login').AsString := LLogin;
    Q.ParamByName('pass').AsString := APassword;

    Q.Open;
    Result := not Q.IsEmpty;

    if Result then
    begin
      if Q.FindField('Id') <> nil then
        FCurrentUserId := Q.FieldByName('Id').AsInteger;
      if Q.FindField('Username') <> nil then
        FCurrentUsername := Q.FieldByName('Username').AsString;
      if Q.FindField('Email') <> nil then
        FCurrentEmail := Q.FieldByName('Email').AsString;
    end;
  finally
    Q.Free;
  end;
end;

end.

